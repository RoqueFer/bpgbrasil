{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscar Artigos - Boletim Paranaense de Geociências</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:wght@400;700&family=Roboto:wght@700&family=Rubik+Dirt&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/layout_artigos.css' %}">

</head>

<body>
    <meu-header></meu-header>

    <main>
        <div class="main-content-wrapper">
            <div class="container">
                <div class="content-area">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Buscar por título, autor, DOI..."
                            class="search-input">

                        <div class="dropdown">
                            <button class="filter-button" data-dropdown-button>Data ▼</button>
                            <div class="dropdown-content" id="year-filter-options">
                                <a href="#" class="filter-option" data-filter-type="year" data-filter-value="all">Todos
                                    os Anos</a>
                                <a href="#" class="filter-option" data-filter-type="year"
                                    data-filter-value="2024">2024</a>
                                </div>
                        </div>

                        <div class="dropdown">
                            <button class="filter-button" data-dropdown-button>Edição ▼</button>
                            <div class="dropdown-content" id="edition-filter-options">
                                </div>
                        </div>

                        <button class="filter-button" id="clear-filters-btn" title="Limpar todos os filtros">Limpar
                            filtro</button>
                    </div>

                    <div class="volume-section">
                        <h3 class="volume-title" id="volume-title">Todos os Artigos</h3>
                        <div class="articles-grid" id="articles-grid">
                            <div class="article-card" data-year="2024" data-edition="Volume 82, N.1 (2024)"><span
                                    class="article-tag">Volume 82, N.1 (2024)</span>
                                <p><strong>- Artigo 1</strong></p>
                                <p>Autor: A. Silva</p>
                                <p>DOI: 10.1234/bpg.v82n1.1111</p>
                                <div class="article-summary-popup">
                                    <h4>Artigo 1 (2024)</h4>
                                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce turpis lectus,
                                        blandit quis arcu quis, aliquam imperdiet nunc.</p>
                                </div>
                            </div>
                            </div>
                        <div id="no-results">Nenhum artigo encontrado.</div>
                    </div>

                    <div class="pagination-container" id="pagination-container"></div>
                </div>
            </div>
        </div>
    </main>

    <meu-footer></meu-footer>

    <script src="{% static 'js/meu-header.js' %}"></script>
    <script src="{% static 'js/meu-footer.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            const articlesGrid = document.getElementById('articles-grid');
            const allArticles = Array.from(articlesGrid.querySelectorAll('.article-card'));
            const noResultsMsg = document.getElementById('no-results');
            const volumeTitle = document.getElementById('volume-title');
            const paginationContainer = document.getElementById('pagination-container');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            const editionDropdownContent = document.getElementById('edition-filter-options');
            const editionFilterButton = editionDropdownContent.previousElementSibling;

            const articlesPerPage = 8;
            let currentPage = 1;
            let currentFilteredArticles = [...allArticles];
            const activeFilters = { year: 'all', edition: 'all', search: '' };

            const setupPagination = () => {
                paginationContainer.innerHTML = '';
                const pageCount = Math.ceil(currentFilteredArticles.length / articlesPerPage);
                if (pageCount <= 1) return;

                const createPageLink = (page, text = page, isDisabled = false) => {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.innerHTML = text;
                    link.className = 'page-link';
                    if (isDisabled) link.classList.add('disabled');
                    if (page === currentPage) link.classList.add('active');
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (!isDisabled && page !== currentPage) {
                            currentPage = page;
                            displayPage();
                        }
                    });
                    return link;
                };

                paginationContainer.appendChild(createPageLink(currentPage - 1, '&lt;', currentPage === 1));
                for (let i = 1; i <= pageCount; i++) {
                    paginationContainer.appendChild(createPageLink(i));
                }
                paginationContainer.appendChild(createPageLink(currentPage + 1, '&gt;', currentPage === pageCount));
            };

            const displayPage = () => {
                allArticles.forEach(article => article.style.display = 'none');
                const startIndex = (currentPage - 1) * articlesPerPage;
                const endIndex = startIndex + articlesPerPage;
                currentFilteredArticles.slice(startIndex, endIndex).forEach(article => {
                    article.style.display = 'flex';
                });
                setupPagination();
            };

            const applyFiltersAndPaginate = () => {
                currentFilteredArticles = allArticles.filter(article => {
                    const articleYear = article.dataset.year;
                    const articleEdition = article.dataset.edition;
                    const articleContent = article.textContent.toLowerCase();

                    const matchesYear = activeFilters.year === 'all' || activeFilters.year === articleYear;
                    const matchesEdition = activeFilters.edition === 'all' || activeFilters.edition === articleEdition;
                    const matchesSearch = activeFilters.search === '' || articleContent.includes(activeFilters.search);

                    return matchesYear && matchesEdition && matchesSearch;
                });

                noResultsMsg.style.display = currentFilteredArticles.length === 0 ? 'block' : 'none';
                currentPage = 1;
                displayPage();
            };

            const updateEditionFilter = (selectedYear) => {
                editionDropdownContent.innerHTML = '<a href="#" class="filter-option" data-filter-type="edition" data-filter-value="all">Todas as Edições</a>';

                const articlesForYear = selectedYear === 'all'
                    ? allArticles
                    : allArticles.filter(a => a.dataset.year === selectedYear);

                const editions = [...new Set(Array.from(articlesForYear).map(a => a.dataset.edition))];
                editions.sort((a, b) => b.localeCompare(a, undefined, { numeric: true }));

                editions.forEach(edition => {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.className = 'filter-option';
                    link.dataset.filterType = 'edition';
                    link.dataset.filterValue = edition;
                    link.textContent = edition;
                    editionDropdownContent.appendChild(link);
                });
            };

            document.addEventListener('click', e => {
                const isDropdownButton = e.target.matches("[data-dropdown-button]");
                if (!isDropdownButton && e.target.closest('.dropdown') === null) {
                    document.querySelectorAll(".dropdown.active").forEach(d => d.classList.remove("active"));
                }
                if (isDropdownButton) {
                    const currentDropdown = e.target.closest('.dropdown');
                    const wasActive = currentDropdown.classList.contains('active');
                    document.querySelectorAll(".dropdown.active").forEach(d => d.classList.remove("active"));
                    if (!wasActive) currentDropdown.classList.add('active');
                }
                if (e.target.classList.contains('filter-option')) {
                    e.preventDefault();
                    const { filterType, filterValue } = e.target.dataset;
                    activeFilters[filterType] = filterValue;

                    const dropdownButton = e.target.closest('.dropdown').querySelector('[data-dropdown-button]');
                    dropdownButton.textContent = filterValue === 'all' ? (filterType === 'year' ? 'Data ▼' : 'Edição ▼') : e.target.textContent;

                    if (filterType === 'year') {
                        volumeTitle.textContent = filterValue === 'all' ? 'Todos os Artigos' : `Artigos de ${filterValue}`;
                        activeFilters.edition = 'all'; // Reseta o filtro de edição
                        editionFilterButton.textContent = 'Edição ▼'; // Reseta o botão de edição
                        updateEditionFilter(filterValue); // Atualiza as opções de edição
                    } else if (filterType === 'edition') {
                        volumeTitle.textContent = filterValue === 'all' ? `Artigos de ${activeFilters.year}` : filterValue;
                        if (activeFilters.year === 'all' && filterValue !== 'all') {
                            volumeTitle.textContent = filterValue;
                        }
                    }

                    applyFiltersAndPaginate();
                    e.target.closest('.dropdown').classList.remove('active');
                }
            });

            searchInput.addEventListener('input', e => {
                activeFilters.search = e.target.value.toLowerCase();
                applyFiltersAndPaginate();
            });

            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    activeFilters.year = 'all';
                    activeFilters.edition = 'all';
                    activeFilters.search = '';
                    searchInput.value = '';
                    document.querySelectorAll('[data-dropdown-button]').forEach(button => {
                        const dropdownContent = button.nextElementSibling;
                        if (dropdownContent.id === 'year-filter-options') { button.textContent = 'Data ▼'; }
                        else if (dropdownContent.id === 'edition-filter-options') { button.textContent = 'Edição ▼'; }
                    });
                    volumeTitle.textContent = "Todos os Artigos";
                    updateEditionFilter('all');
                    applyFiltersAndPaginate();
                });
            }

            articlesGrid.addEventListener('pointerover', e => {
                const card = e.target.closest('.article-card');
                if (!card || card.style.display === 'none') return;

                const popup = card.querySelector('.article-summary-popup');
                if (!popup) return;

                const cardRect = card.getBoundingClientRect();
                const gridRect = articlesGrid.getBoundingClientRect();

                if (window.innerWidth > 900) {
                    if (cardRect.left < gridRect.left + (gridRect.width / 2)) {
                        popup.classList.add('summary-show-right');
                        popup.classList.remove('summary-show-left');
                    } else {
                        popup.classList.add('summary-show-left');
                        popup.classList.remove('summary-show-right');
                    }
                }

                const viewportHeight = window.innerHeight;
                if (cardRect.top + (popup.offsetHeight / 2) > viewportHeight / 2) {
                    popup.classList.add('summary-align-bottom');
                    popup.classList.remove('summary-align-top');
                } else {
                    popup.classList.add('summary-align-top');
                    popup.classList.remove('summary-align-bottom');
                }
            });

            // --- INICIALIZAÇÃO ---
            updateEditionFilter('all');
            applyFiltersAndPaginate();
        });
    </script>
</body>

</html>